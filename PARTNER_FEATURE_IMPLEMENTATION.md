# 応援パートナー機能 実装ドキュメント

## 概要
応援パートナー(多額の寄付者等)に対して、その方が作成したすべてのコンテンツ(診断クイズ・プロフィールLP・ビジネスLP)に自動的にPro特典(HTMLダウンロード、埋め込みコード、CSVエクスポート等)を付与する機能を実装しました。

## 実装内容

### 1. データベーススキーマ

#### 新規ファイル: `supabase_user_roles.sql`
- `user_roles`テーブルを作成
- パートナー情報(is_partner, partner_since, partner_note)を管理
- RPC関数を実装:
  - `check_is_partner(user_id)`: パートナーステータスを確認
  - `set_partner_status(user_id, status, note)`: パートナーステータスを設定
  - `get_all_users_with_roles()`: 全ユーザーと寄付情報を取得

### 2. アクセス権チェックロジック

#### 修正ファイル: `app/actions/purchases.ts`

**追加された関数:**
- `checkIsPartner(userId)`: ユーザーがパートナーかどうかを確認
- `setPartnerStatus(userId, isPartner, note)`: パートナーステータスを設定（管理者専用）
- `getAllUsersWithRoles()`: 全ユーザー情報とロールを取得（管理者専用）

**修正された関数:**
- `hasProAccess(userId, userEmail, contentId, contentType, contentOwnerId)`:
  - 新しいパラメータ `contentOwnerId` を追加
  - アクセス権チェックの優先順位:
    1. 管理者 → 全コンテンツにアクセス可能
    2. パートナー + 自分が作成したコンテンツ → アクセス可能 ✨ **NEW**
    3. 該当コンテンツを購入済み → アクセス可能

### 3. 管理画面UI

#### 修正ファイル: `app/dashboard/page.tsx`

**追加された機能:**
- ユーザー管理セクション（管理者専用）
  - ユーザー一覧表示（メールアドレス、パートナーステータス、総寄付額、購入数、登録日）
  - パートナー設定/解除トグルボタン
  - メモ欄（寄付額や理由を記録可能）
  
**Pro機能表示の改善:**
- コンテンツカードにアクセス権情報を表示
- パートナー特典の場合: "✨ 応援パートナー特典" バッジを表示
- 購入済みの場合: "Pro機能利用可能" バッジを表示

**実装の詳細:**
- `proAccessMap` ステートを追加し、各コンテンツのアクセス権を管理
- `fetchProAccessForContents()` 関数でコンテンツごとにアクセス権をチェック
- `ContentItem` 型に `user_id` フィールドを追加

### 4. データフロー

```
[ユーザーログイン]
    ↓
[ダッシュボード表示]
    ↓
[コンテンツ一覧取得 + user_id含む]
    ↓
[各コンテンツに対してhasProAccess()を呼び出し]
    ↓
[アクセス権情報をproAccessMapに保存]
    ↓
[UI表示: パートナーバッジ or 購入済みバッジ or ロック状態]
```

### 5. 管理者操作フロー

```
[管理画面: ユーザー管理セクション]
    ↓
[ユーザー一覧を表示ボタンをクリック]
    ↓
[getAllUsersWithRoles()でユーザー情報取得]
    ↓
[対象ユーザーの「パートナーに設定」ボタンをクリック]
    ↓
[メモ入力（任意）]
    ↓
[setPartnerStatus()実行]
    ↓
[user_rolesテーブル更新]
    ↓
[ユーザー一覧を再読み込み]
```

## 使用方法

### 管理者: パートナー設定

1. ダッシュボードにログイン（管理者メールアドレスで）
2. 「ユーザー管理」セクションまでスクロール
3. 「ユーザー一覧を表示」ボタンをクリック
4. 対象ユーザーの「パートナーに設定」ボタンをクリック
5. メモ欄に理由や寄付額を入力（任意）
6. 「設定」ボタンをクリック
7. 確認ダイアログで「OK」

### パートナーユーザー: Pro機能の利用

パートナーに設定されたユーザーは:
- 自分が作成した全てのコンテンツで自動的にPro機能が利用可能
- ダッシュボードのコンテンツカードに「✨ 応援パートナー特典」バッジが表示される
- HTMLダウンロード、埋め込みコード、CSVエクスポートなどが無制限で利用可能
- 他のユーザーが作成したコンテンツは通常通り購入が必要

## データベースセットアップ

Supabaseのコンソールで以下のSQLファイルを実行してください:

```bash
supabase_user_roles.sql
```

実行後、以下のテーブルとRPC関数が作成されます:
- テーブル: `user_roles`
- RPC関数: `check_is_partner`, `set_partner_status`, `get_all_users_with_roles`
- ビュー: `partner_users`

## セキュリティ

- パートナー設定は管理者のみ実行可能
- `hasProAccess()`関数は必ず`contentOwnerId`を確認し、パートナーは自分のコンテンツのみアクセス可能
- RPC関数は`SECURITY DEFINER`で実行され、適切な権限チェックを実施

## テストシナリオ

### ✅ 1. パートナーユーザーが自分の全コンテンツでHTMLダウンロード可能

1. ユーザーAをパートナーに設定
2. ユーザーAで複数のコンテンツ(クイズ、プロフィール、ビジネスLP)を作成
3. ダッシュボードで各コンテンツに「✨ 応援パートナー特典」バッジが表示される
4. 埋め込みボタンが有効になっている
5. （管理者として）HTMLダウンロードも可能

### ✅ 2. パートナーユーザーが他人のコンテンツはダウンロード不可

1. ユーザーAをパートナーに設定
2. ユーザーBが作成したコンテンツを確認
3. パートナーバッジは表示されない
4. 購入していない場合、「Pro機能を開放（寄付）」ボタンが表示される

### ✅ 3. 非パートナーユーザーは従来通り購入が必要

1. パートナーでないユーザーCでログイン
2. 自分のコンテンツを確認
3. パートナーバッジは表示されない
4. 購入済みでない場合、ロック状態
5. 購入すると「Pro機能利用可能」バッジが表示される

### ✅ 4. 管理者は全コンテンツにアクセス可能

1. 管理者メールでログイン
2. 全ユーザーのコンテンツが表示される
3. 全てのコンテンツでHTMLダウンロードボタンが表示される
4. 制限なく全機能が利用可能

### ✅ 5. パートナー設定/解除が管理画面から可能

1. 管理者でログイン
2. ユーザー管理セクションを開く
3. ユーザーをパートナーに設定できる
4. メモを追加できる
5. パートナーを解除できる
6. ステータスがリアルタイムに反映される

## 影響範囲

### ✅ 既存機能への影響なし
- 購入機能は引き続き正常動作
- 管理者権限は変更なし
- パートナーでないユーザーの動作は従来通り

### 🆕 新規追加機能
- パートナーステータス管理
- パートナー向け自動Pro機能開放
- ユーザー管理UI（管理者専用）

## 今後の拡張案

1. **パートナーレベルの導入**
   - Bronze/Silver/Gold等のレベル設定
   - レベルに応じた特典の差別化

2. **期限付きパートナー**
   - 有効期限の設定
   - 自動更新/通知機能

3. **寄付額による自動パートナー設定**
   - 一定額以上の寄付で自動的にパートナーに昇格
   - `purchases`テーブルの総額をトリガーで監視

4. **パートナー専用コンテンツ**
   - パートナー限定の機能やテンプレート
   - 優先サポートチャンネル

## まとめ

この実装により、多額の寄付をいただいた応援パートナーに対して、特別な特典を提供できるようになりました。管理者は簡単にパートナーを管理でき、パートナーユーザーは自分の全コンテンツでPro機能を自由に使えます。既存の購入システムとも共存し、柔軟な運用が可能です。



























































