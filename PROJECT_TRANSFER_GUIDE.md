# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«LPãƒ¡ãƒ¼ã‚«ãƒ¼ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè»¢ç”¨ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«LPãƒ¡ãƒ¼ã‚«ãƒ¼ã®å…¨ä½“æ§‹é€ ã‚’ç†è§£ã—ã€ä»–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è»¢ç”¨ã™ã‚‹ãŸã‚ã®è©³ç´°ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](#1-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦)
2. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#2-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
3. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#3-ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
4. [ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°](#4-ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°)
5. [ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°](#5-ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°)
6. [å¯„ä»˜ãƒ»æ±ºæ¸ˆæ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°](#6-å¯„ä»˜æ±ºæ¸ˆæ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°)
7. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#7-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
8. [è»¢ç”¨æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#8-è»¢ç”¨æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ç¾ã—ã„ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«LPï¼ˆãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼‰ã‚’ä½œæˆã§ãã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚
SNSãƒªãƒ³ã‚¯ã¾ã¨ã‚ä»¥ä¸Šã®ä¾¡å€¤ã‚’æä¾›ã—ã€å€‹äººäº‹æ¥­ä¸»ã‚„ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹å‘ã‘ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªLPä½œæˆãƒ„ãƒ¼ãƒ«ã€‚

### ä¸»ãªæ©Ÿèƒ½
- **ãƒ–ãƒ­ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ‡ã‚£ã‚¿**: 12ç¨®é¡ä»¥ä¸Šã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ã§å¤šæ§˜ãªè¡¨ç¾
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½**: æ¥­ç¨®åˆ¥ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹**: è©³ç´°ãªã‚¢ã‚¯ã‚»ã‚¹è§£æã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ
- **ãƒªãƒ¼ãƒ‰ç²å¾—**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åé›†æ©Ÿèƒ½
- **æ±ºæ¸ˆé€£æº**: Stripeæ±ºæ¸ˆã§Proæ©Ÿèƒ½é–‹æ”¾ï¼ˆHTMLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼‰

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
| æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|-----------|------|
| Next.js | 16.0.7 | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆApp Routerï¼‰ |
| React | 19.2.1 | UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª |
| TypeScript | 5.x | å‹å®‰å…¨ãªé–‹ç™º |
| Tailwind CSS | 4.x | ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° |
| Lucide React | 0.555.0 | ã‚¢ã‚¤ã‚³ãƒ³ |
| Recharts | 3.5.1 | ã‚°ãƒ©ãƒ•è¡¨ç¤º |
| qrcode.react | 4.2.0 | QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ |
| canvas-confetti | 1.9.4 | ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
| æŠ€è¡“ | ç”¨é€” |
|------|------|
| Supabase (PostgreSQL) | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
| Supabase Auth | èªè¨¼ |
| Supabase Storage | ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| Stripe | æ±ºæ¸ˆ |
| OpenAI API | AIè‡ªå‹•ç”Ÿæˆ |

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
profile-lp-maker/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ actions/                  # â˜… Server Actions
â”‚   â”‚   â”œâ”€â”€ analytics.ts         # ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ leads.ts             # ãƒªãƒ¼ãƒ‰ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ profiles.ts          # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
â”‚   â”‚   â””â”€â”€ users.ts             # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                      # â˜… API Routes
â”‚   â”‚   â”œâ”€â”€ analytics/route.ts   # ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹APIï¼ˆsendBeaconç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ checkout-profile/    # æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
â”‚   â”‚   â”œâ”€â”€ verify-profile/      # æ±ºæ¸ˆæ¤œè¨¼
â”‚   â”‚   â”œâ”€â”€ upload-image/        # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ generate-profile/    # AIç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ search-images/       # ç”»åƒæ¤œç´¢ï¼ˆUnsplashï¼‰
â”‚   â”‚   â”œâ”€â”€ export-users-csv/    # CSVå‡ºåŠ›
â”‚   â”‚   â””â”€â”€ export-users-sheets/ # Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/                # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ editor/
â”‚   â”‚   â”‚   â”œâ”€â”€ [slug]/page.tsx  # æ—¢å­˜ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
â”‚   â”‚   â”‚   â””â”€â”€ new/page.tsx     # æ–°è¦ä½œæˆ
â”‚   â”‚   â””â”€â”€ page.tsx             # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒˆãƒƒãƒ—
â”‚   â”‚
â”‚   â”œâ”€â”€ p/                        # å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸
â”‚   â”‚   â””â”€â”€ [slug]/page.tsx      # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx                # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”œâ”€â”€ page.jsx                  # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ robots.ts                 # robots.txtç”Ÿæˆ
â”‚   â””â”€â”€ sitemap.ts                # sitemap.xmlç”Ÿæˆ
â”‚
â”œâ”€â”€ components/                   # â˜… Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ ProfileEditor.tsx        # ã‚¨ãƒ‡ã‚£ã‚¿æœ¬ä½“ï¼ˆ2777è¡Œï¼‰
â”‚   â”œâ”€â”€ ProfileDashboard.jsx     # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ BlockRenderer.tsx        # ãƒ–ãƒ­ãƒƒã‚¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
â”‚   â”œâ”€â”€ ProfileViewTracker.tsx   # ãƒ“ãƒ¥ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
â”‚   â”œâ”€â”€ LinkClickTracker.tsx     # ã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
â”‚   â”œâ”€â”€ TrackingScripts.tsx      # å¤–éƒ¨è¨ˆæ¸¬ã‚¿ã‚°ï¼ˆGTM/FB/LINEï¼‰
â”‚   â”œâ”€â”€ AuthModal.jsx            # èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚   â”œâ”€â”€ Header.jsx               # ãƒ˜ãƒƒãƒ€ãƒ¼
â”‚   â””â”€â”€ Footer.jsx               # ãƒ•ãƒƒã‚¿ãƒ¼
â”‚
â”œâ”€â”€ lib/                          # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ types.ts                 # TypeScriptå‹å®šç¾©
â”‚   â”œâ”€â”€ supabase.js              # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ supabase-server.ts       # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰Supabase
â”‚   â”œâ”€â”€ utils.js                 # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”‚   â”œâ”€â”€ profileHtmlGenerator.ts  # HTMLç”Ÿæˆ
â”‚   â””â”€â”€ constants.js             # å®šæ•°
â”‚
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ templates.ts             # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©
â”‚
â””â”€â”€ [SQLãƒ•ã‚¡ã‚¤ãƒ«ç¾¤]               # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
    â”œâ”€â”€ supabase_analytics_setup.sql
    â””â”€â”€ supabase_profile_purchases_setup.sql
```

---

## 4. ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°

### 4.1 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `components/ProfileEditor.tsx` | ã‚¨ãƒ‡ã‚£ã‚¿æœ¬ä½“ï¼ˆæœ€é‡è¦ãƒ»2777è¡Œï¼‰ |
| `lib/types.ts` | ãƒ–ãƒ­ãƒƒã‚¯å‹å®šç¾© |
| `app/actions/profiles.ts` | ä¿å­˜å‡¦ç†ï¼ˆServer Actionï¼‰ |
| `constants/templates.ts` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾© |
| `components/BlockRenderer.tsx` | ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤º |
| `app/dashboard/editor/[slug]/page.tsx` | ç·¨é›†ãƒšãƒ¼ã‚¸ |
| `app/dashboard/editor/new/page.tsx` | æ–°è¦ä½œæˆãƒšãƒ¼ã‚¸ |

### 4.2 ãƒ–ãƒ­ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 

#### å‹å®šç¾©ï¼ˆ`lib/types.ts`ï¼‰

```typescript
// ãƒ–ãƒ­ãƒƒã‚¯ã®åŸºæœ¬æ§‹é€ 
export type Block = 
  | { id: string; type: 'header'; data: HeaderBlockData }
  | { id: string; type: 'text_card'; data: TextCardBlockData }
  | { id: string; type: 'image'; data: ImageBlockData }
  | { id: string; type: 'youtube'; data: YouTubeBlockData }
  | { id: string; type: 'links'; data: LinksBlockData }
  | { id: string; type: 'kindle'; data: KindleBlockData }
  | { id: string; type: 'lead_form'; data: LeadFormBlockData }
  | { id: string; type: 'line_card'; data: LineCardBlockData }
  | { id: string; type: 'faq'; data: FAQBlockData }
  | { id: string; type: 'pricing'; data: PricingBlockData }
  | { id: string; type: 'testimonial'; data: TestimonialBlockData }
  | { id: string; type: 'quiz'; data: QuizBlockData }
  | { id: string; type: 'google_map'; data: GoogleMapBlockData };

// å„ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿å‹ä¾‹
export type HeaderBlockData = {
  avatar: string;    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL
  name: string;      // åå‰
  title: string;     // ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼
  category?: string; // ã‚«ãƒ†ã‚´ãƒª
};

// ä¸€æ„ã®IDã‚’ç”Ÿæˆ
export function generateBlockId(): string {
  return `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}
```

#### ç¾åœ¨å¯¾å¿œã—ã¦ã„ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§

| ã‚¿ã‚¤ãƒ— | åç§° | ç”¨é€” |
|--------|------|------|
| `header` | ãƒ˜ãƒƒãƒ€ãƒ¼ | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã€åå‰ã€ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ |
| `text_card` | ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ | ã‚¿ã‚¤ãƒˆãƒ«ä»˜ããƒ†ã‚­ã‚¹ãƒˆ |
| `image` | ç”»åƒ | ç”»åƒã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ |
| `youtube` | YouTube | å‹•ç”»åŸ‹ã‚è¾¼ã¿ |
| `links` | ãƒªãƒ³ã‚¯ | SNSãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ç¾¤ |
| `kindle` | Kindle | æ›¸ç±ç´¹ä»‹ã‚«ãƒ¼ãƒ‰ |
| `lead_form` | ãƒªãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹åé›† |
| `line_card` | LINEç™»éŒ² | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèª˜å° |
| `faq` | FAQ | ã‚ˆãã‚ã‚‹è³ªå• |
| `pricing` | æ–™é‡‘è¡¨ | ãƒ—ãƒ©ãƒ³ãƒ»ä¾¡æ ¼è¡¨ç¤º |
| `testimonial` | ãŠå®¢æ§˜ã®å£° | æ¨è–¦æ–‡ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| `quiz` | ã‚¯ã‚¤ã‚º | è¨ºæ–­ã‚¯ã‚¤ã‚ºåŸ‹ã‚è¾¼ã¿ |
| `google_map` | Googleãƒãƒƒãƒ— | åœ°å›³åŸ‹ã‚è¾¼ã¿ |

### 4.3 ã‚¨ãƒ‡ã‚£ã‚¿ã®ä¸»è¦State

```typescript
// ProfileEditor.tsx å†…ã®State
const [blocks, setBlocks] = useState<Block[]>(getDefaultContent());
const [theme, setTheme] = useState<{ gradient?: string; backgroundImage?: string }>({});
const [settings, setSettings] = useState<{ gtmId?: string; fbPixelId?: string; lineTagId?: string }>({});
const [analytics, setAnalytics] = useState({
  views: 0,
  clicks: 0,
  avgScrollDepth: 0,
  avgTimeSpent: 0,
  readRate: 0,
  clickRate: 0
});
const [featuredOnTop, setFeaturedOnTop] = useState(true);
```

### 4.4 ã‚¨ãƒ‡ã‚£ã‚¿ã®ä¸»è¦é–¢æ•°

```typescript
// ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ 
const addBlock = (type: Block['type']) => {
  const newBlock = createBlockByType(type);
  setBlocks(prev => [...prev, newBlock]);
  setExpandedBlocks(prev => new Set([...prev, newBlock.id]));
};

// ãƒ–ãƒ­ãƒƒã‚¯æ›´æ–°
const updateBlock = (blockId: string, updates: Partial<Block['data']>) => {
  setBlocks(prev => prev.map(block => {
    if (block.id === blockId) {
      return { ...block, data: { ...block.data, ...updates } } as Block;
    }
    return block;
  }));
};

// ãƒ–ãƒ­ãƒƒã‚¯å‰Šé™¤
const removeBlock = (blockId: string) => {
  if (!confirm('ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  setBlocks(prev => prev.filter(b => b.id !== blockId));
};

// ãƒ–ãƒ­ãƒƒã‚¯ç§»å‹•
const moveBlock = (blockId: string, direction: 'up' | 'down') => {
  setBlocks(prev => {
    const index = prev.findIndex(b => b.id === blockId);
    if (index === -1) return prev;
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex < 0 || newIndex >= prev.length) return prev;
    const newBlocks = [...prev];
    const [movedBlock] = newBlocks.splice(index, 1);
    newBlocks.splice(newIndex, 0, movedBlock);
    return newBlocks;
  });
};

// ä¿å­˜ï¼ˆServer ActionçµŒç”±ï¼‰
const handleSave = async () => {
  setIsSaving(true);
  const result = await saveProfile({
    slug: savedSlug || generateSlug(name),
    content: blocks,
    settings: { ...settings, theme },
    userId: user?.id || null,
    featuredOnTop
  });
  if (result.error) {
    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } else {
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
  }
  setIsSaving(false);
};
```

### 4.5 ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```typescript
// RLSã‚’å›é¿ã™ã‚‹ãŸã‚ã«APIãƒ«ãƒ¼ãƒˆçµŒç”±ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
const uploadImageViaApi = async (file: File, prefix: string) => {
  const fileExt = file.name.split('.').pop();
  const fileName = `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;

  const formData = new FormData();
  formData.append('file', file);
  formData.append('folder', uploadOwnerId);  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ãƒ•ã‚©ãƒ«ãƒ€åˆ†é›¢
  formData.append('fileName', fileName);

  const res = await fetch('/api/upload-image', { method: 'POST', body: formData });
  if (!res.ok) {
    throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
  const data = await res.json();
  return data.publicUrl;
};
```

### 4.6 æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•

1. **å‹å®šç¾©ã‚’è¿½åŠ **ï¼ˆ`lib/types.ts`ï¼‰
2. **ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¿½åŠ **ï¼ˆ`ProfileEditor.tsx`ï¼‰
3. **ç·¨é›†UIã‚’è¿½åŠ **ï¼ˆ`ProfileEditor.tsx`å†…ã®renderéƒ¨åˆ†ï¼‰
4. **ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã«è¡¨ç¤ºå‡¦ç†ã‚’è¿½åŠ **ï¼ˆ`BlockRenderer.tsx`ï¼‰

---

## 5. ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°

### 5.1 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `components/ProfileViewTracker.tsx` | ãƒ“ãƒ¥ãƒ¼ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»æ»åœ¨æ™‚é–“ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° |
| `components/LinkClickTracker.tsx` | ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° |
| `components/TrackingScripts.tsx` | å¤–éƒ¨è¨ˆæ¸¬ã‚¿ã‚°ï¼ˆGTM/FB/LINEï¼‰ |
| `app/actions/analytics.ts` | ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹Server Action |
| `app/api/analytics/route.ts` | ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹APIï¼ˆsendBeaconç”¨ï¼‰ |
| `supabase_analytics_setup.sql` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ |

### 5.2 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡

| ã‚¤ãƒ™ãƒ³ãƒˆ | èª¬æ˜ | event_data |
|---------|------|------------|
| `view` | ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ | ãªã— |
| `click` | ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ | `{ url: string }` |
| `scroll` | ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦ | `{ scrollDepth: 25/50/75/100 }` |
| `time` | æ»åœ¨æ™‚é–“ | `{ timeSpent: number }` ï¼ˆç§’ï¼‰ |
| `read` | ç²¾èª­åˆ¤å®š | `{ readPercentage: number }` |

### 5.3 ProfileViewTrackerå®Ÿè£…

```typescript
// components/ProfileViewTracker.tsx

export function ProfileViewTracker({ profileId, contentType = 'profile' }) {
  const startTimeRef = useRef<number>(Date.now());
  const maxScrollRef = useRef<number>(0);
  const scrollTrackedRef = useRef<Set<number>>(new Set());
  const viewTrackedRef = useRef<boolean>(false);

  useEffect(() => {
    if (!profileId || profileId === 'demo') return;

    // â˜… ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ã‚’è¨˜éŒ²ï¼ˆåˆå›ã®ã¿ï¼‰
    if (!viewTrackedRef.current) {
      viewTrackedRef.current = true;
      saveAnalytics(profileId, 'view', undefined, contentType);
    }

    // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦ã‚’è¿½è·¡
    const handleScroll = () => {
      const scrollTop = window.pageYOffset;
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollDepth = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
      
      maxScrollRef.current = Math.max(maxScrollRef.current, scrollDepth);

      // 25%, 50%, 75%, 100%ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’è¨˜éŒ²
      [25, 50, 75, 100].forEach(milestone => {
        if (scrollDepth >= milestone && !scrollTrackedRef.current.has(milestone)) {
          scrollTrackedRef.current.add(milestone);
          saveAnalytics(profileId, 'scroll', { scrollDepth: milestone }, contentType);
        }
      });
    };

    // â˜… ç²¾èª­åˆ¤å®šï¼ˆ50%ä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ç²¾èª­ã¨ã¿ãªã™ï¼‰
    const checkReadRate = () => {
      if (maxScrollRef.current >= 50) {
        saveAnalytics(profileId, 'read', { readPercentage: maxScrollRef.current }, contentType);
      }
    };

    window.addEventListener('scroll', handleScroll);

    // â˜… å®šæœŸçš„ã«æ»åœ¨æ™‚é–“ã‚’è¨˜éŒ²ï¼ˆ30ç§’ã”ã¨ï¼‰
    const timeInterval = setInterval(() => {
      const timeSpent = Math.round((Date.now() - startTimeRef.current) / 1000);
      if (timeSpent >= 30) {
        saveAnalytics(profileId, 'time', { timeSpent }, contentType);
      }
    }, 30000);

    // â˜… ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«æ»åœ¨æ™‚é–“ã‚’è¨˜éŒ²ï¼ˆsendBeaconä½¿ç”¨ï¼‰
    const handleBeforeUnload = () => {
      const timeSpent = Math.round((Date.now() - startTimeRef.current) / 1000);
      if (timeSpent > 0) {
        const blob = new Blob(
          [JSON.stringify({ profileId, eventType: 'time', eventData: { timeSpent } })],
          { type: 'application/json' }
        );
        navigator.sendBeacon('/api/analytics', blob);
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('beforeunload', handleBeforeUnload);
      clearInterval(timeInterval);
    };
  }, [profileId, contentType]);

  return null;
}
```

### 5.4 ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ä¿å­˜Server Action

```typescript
// app/actions/analytics.ts

export async function saveAnalytics(
  profileId: string, 
  eventType: 'view' | 'click' | 'scroll' | 'time' | 'read', 
  eventData?: { url?: string; scrollDepth?: number; timeSpent?: number; readPercentage?: number; },
  contentType?: 'profile' | 'business'
) {
  // UUIDã®å½¢å¼ãƒã‚§ãƒƒã‚¯
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidRegex.test(profileId)) {
    return { error: 'Invalid profile ID format' };
  }

  const insertData = {
    profile_id: profileId,
    event_type: eventType,
    event_data: eventData || {},
    content_type: contentType || 'profile',
    created_at: new Date().toISOString()
  };

  const { data, error } = await supabase
    .from('analytics')
    .insert([insertData])
    .select();

  if (error) return { error: error.message };
  return { success: true, data };
}
```

### 5.5 ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å–å¾—ãƒ»é›†è¨ˆ

```typescript
// app/actions/analytics.ts

export async function getAnalytics(profileId: string) {
  const { data: allEvents } = await supabase
    .from('analytics')
    .select('*')
    .eq('profile_id', profileId)
    .eq('content_type', 'profile');

  const views = allEvents?.filter(e => e.event_type === 'view') || [];
  const clicks = allEvents?.filter(e => e.event_type === 'click') || [];
  const scrolls = allEvents?.filter(e => e.event_type === 'scroll') || [];
  const times = allEvents?.filter(e => e.event_type === 'time') || [];
  const reads = allEvents?.filter(e => e.event_type === 'read') || [];

  // å¹³å‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦
  const avgScrollDepth = calculateAverage(scrolls, 'scrollDepth');

  // å¹³å‡æ»åœ¨æ™‚é–“ï¼ˆç§’ï¼‰
  const avgTimeSpent = calculateAverage(times, 'timeSpent');

  // ç²¾èª­ç‡ï¼ˆ50%ä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸå‰²åˆï¼‰
  const readCount = reads.filter(e => e.event_data?.readPercentage >= 50).length;
  const readRate = views.length > 0 ? Math.round((readCount / views.length) * 100) : 0;

  // ã‚¯ãƒªãƒƒã‚¯ç‡
  const clickRate = views.length > 0 ? Math.round((clicks.length / views.length) * 100) : 0;

  return {
    views: views.length,
    clicks: clicks.length,
    avgScrollDepth,
    avgTimeSpent,
    readRate,
    clickRate
  };
}
```

### 5.6 å¤–éƒ¨è¨ˆæ¸¬ã‚¿ã‚°ï¼ˆTrackingScriptsï¼‰

```typescript
// components/TrackingScripts.tsx

export function TrackingScripts({ settings }) {
  return (
    <>
      {/* Google Tag Manager */}
      {settings?.gtmId && (
        <Script id="gtm-script" strategy="afterInteractive">
          {`(function(w,d,s,l,i){...})(window,document,'script','dataLayer','${settings.gtmId}');`}
        </Script>
      )}

      {/* Facebook Pixel */}
      {settings?.fbPixelId && (
        <Script id="fb-pixel" strategy="afterInteractive">
          {`fbq('init', '${settings.fbPixelId}');fbq('track', 'PageView');`}
        </Script>
      )}

      {/* LINE Tag */}
      {settings?.lineTagId && (
        <Script id="line-tag" strategy="afterInteractive">
          {/* LINE Tag ã‚³ãƒ¼ãƒ‰ */}
        </Script>
      )}
    </>
  );
}
```

### 5.7 ã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ã®ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹è¡¨ç¤º

```typescript
// ProfileEditor.tsx å†…

// ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
useEffect(() => {
  const loadProfile = async () => {
    // ...ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¾Œ
    if (data.id) {
      const analyticsData = await getAnalytics(data.id);
      setAnalytics(analyticsData);
    }
  };
  loadProfile();
}, [initialSlug]);

// è¡¨ç¤ºéƒ¨åˆ†
<div className="grid grid-cols-2 md:grid-cols-3 gap-4">
  <div className="text-center p-4 bg-blue-50 rounded-lg">
    <div className="text-2xl font-bold text-blue-600">{analytics.views}</div>
    <div className="text-sm text-gray-600">ã‚¢ã‚¯ã‚»ã‚¹æ•°</div>
  </div>
  <div className="text-center p-4 bg-green-50 rounded-lg">
    <div className="text-2xl font-bold text-green-600">{analytics.clicks}</div>
    <div className="text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯æ•°</div>
  </div>
  <div className="text-center p-4 bg-purple-50 rounded-lg">
    <div className="text-2xl font-bold text-purple-600">{analytics.clickRate}%</div>
    <div className="text-sm text-gray-600">ã‚¯ãƒªãƒƒã‚¯ç‡</div>
  </div>
  {/* ... ãã®ä»–ã®æŒ‡æ¨™ */}
</div>
```

---

## 6. å¯„ä»˜ãƒ»æ±ºæ¸ˆæ©Ÿèƒ½ã®å®Ÿè£…è©³ç´°

### 6.1 é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `app/api/checkout-profile/route.js` | Stripeæ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| `app/api/verify-profile/route.js` | æ±ºæ¸ˆæ¤œè¨¼ãƒ»è³¼å…¥å±¥æ­´è¨˜éŒ² |
| `components/ProfileDashboard.jsx` | è³¼å…¥å‡¦ç†UI |
| `supabase_profile_purchases_setup.sql` | è³¼å…¥å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« |

### 6.2 æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼æ¦‚è¦

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ©Ÿèƒ½é–‹æ”¾/å¯„ä»˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
2. é‡‘é¡å…¥åŠ›ï¼ˆ500å††ã€œ50,000å††ï¼‰
   â†“
3. /api/checkout-profile ã«POST
   â†“
4. Stripe Checkout Sessionã‚’ä½œæˆ
   â†“
5. Stripeã®æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   â†“
6. ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»æ±ºæ¸ˆ
   â†“
7. æˆåŠŸå¾Œã€success_urlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   ï¼ˆ?payment=success&session_id=xxx&profile_id=xxxï¼‰
   â†“
8. /api/verify-profile ã§æ±ºæ¸ˆæ¤œè¨¼
   â†“
9. profile_purchasesãƒ†ãƒ¼ãƒ–ãƒ«ã«è³¼å…¥å±¥æ­´ã‚’è¨˜éŒ²
   â†“
10. Proæ©Ÿèƒ½ï¼ˆHTMLãƒ»åŸ‹ã‚è¾¼ã¿ï¼‰ãŒé–‹æ”¾
```

### 6.3 æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆAPI

```javascript
// app/api/checkout-profile/route.js

import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export async function POST(req) {
  const { profileId, profileName, userId, email, price } = await req.json();
  
  // ä¾¡æ ¼ãƒã‚§ãƒƒã‚¯ï¼ˆ500å††ã€œ100,000å††ï¼‰
  let finalPrice = parseInt(price);
  if (isNaN(finalPrice) || finalPrice < 500 || finalPrice > 100000) {
    finalPrice = 1000;
  }

  // ã‚ªãƒªã‚¸ãƒ³ã‚’å–å¾—
  let origin = req.headers.get('origin') || process.env.NEXT_PUBLIC_SITE_URL;

  // Stripe Checkout Sessionä½œæˆ
  const session = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    line_items: [{
      price_data: {
        currency: 'jpy',
        product_data: {
          name: `HTMLãƒ‡ãƒ¼ã‚¿æä¾›: ${profileName}`,
          description: 'ã“ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«LPã®HTMLãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆå¯„ä»˜ãƒ»å¿œæ´ï¼‰',
        },
        unit_amount: finalPrice, 
      },
      quantity: 1,
    }],
    mode: 'payment',
    // â˜… é‡è¦: æˆåŠŸæ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL
    success_url: `${origin}/?payment=success&session_id={CHECKOUT_SESSION_ID}&profile_id=${profileId}&page=dashboard`,
    cancel_url: `${origin}/?payment=cancel&page=dashboard`,
    metadata: {
      userId: userId,
      profileId: profileId,
    },
    customer_email: email,
  });

  return NextResponse.json({ url: session.url });
}
```

### 6.4 æ±ºæ¸ˆæ¤œè¨¼API

```javascript
// app/api/verify-profile/route.js

import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

// â˜… ç®¡ç†è€…æ¨©é™ï¼ˆService Roleï¼‰ã§Supabaseã‚’æ“ä½œ
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY  // â† é‡è¦ï¼
);

export async function POST(req) {
  const { sessionId, profileId, userId } = await req.json();

  // 1. Stripeã«å•ã„åˆã‚ã›ã¦ã€æœ¬å½“ã«æ”¯æ‰•ã„æ¸ˆã¿ã‹ç¢ºèª
  const session = await stripe.checkout.sessions.retrieve(sessionId);
  
  if (session.payment_status !== 'paid') {
    return NextResponse.json({ error: 'Payment not completed' }, { status: 400 });
  }

  // 2. æ—¢ã«è¨˜éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  const { data: existing } = await supabaseAdmin
    .from('profile_purchases')
    .select('id')
    .eq('stripe_session_id', sessionId)
    .single();

  if (existing) {
    return NextResponse.json({ success: true, message: 'Already recorded' });
  }

  // 3. Supabaseã«è³¼å…¥å±¥æ­´ã‚’è¨˜éŒ²
  const { data, error } = await supabaseAdmin
    .from('profile_purchases')
    .insert([{
      user_id: userId,
      profile_id: profileId,
      stripe_session_id: sessionId,
      amount: session.amount_total
    }])
    .select();

  if (error) throw error;

  return NextResponse.json({ success: true, data });
}
```

### 6.5 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼šæ±ºæ¸ˆé–‹å§‹

```javascript
// ProfileDashboard.jsx å†…

const handlePurchase = async (profile) => {
  // é‡‘é¡å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const inputPrice = window.prompt(
    `ã€Œ${getProfileName(profile)}ã€ã®æ©Ÿèƒ½ã‚’é–‹æ”¾ã™ã‚‹ãŸã‚ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\né‡‘é¡ã¯500å††ä»¥ä¸Šã€50,000å††ä»¥ä¸‹ã§è¨­å®šã§ãã¾ã™ã€‚`, 
    "1000"
  );
  if (inputPrice === null) return;
  
  const price = parseInt(inputPrice, 10);
  if (isNaN(price) || price < 500 || price > 50000) {
    alert("é‡‘é¡ã¯500å††ä»¥ä¸Šã€50,000å††ä»¥ä¸‹ã®åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  setProcessingId(profile.id);
  
  try {
    const res = await fetch('/api/checkout-profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        profileId: profile.id,
        profileName: getProfileName(profile),
        userId: user.id,
        email: user.email,
        price: price 
      }),
    });
    
    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;  // Stripeãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    } else {
      throw new Error(data.error || 'æ±ºæ¸ˆURLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    setProcessingId(null);
  }
};
```

### 6.6 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼šæ±ºæ¸ˆæ¤œè¨¼

```javascript
// ProfileDashboard.jsx å†…

const verifyPayment = async (sessionId, profileId) => {
  console.log('ğŸ” æ±ºæ¸ˆæ¤œè¨¼é–‹å§‹:', { sessionId, profileId });
  
  try {
    const res = await fetch('/api/verify-profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, profileId, userId: user.id }),
    });
    
    const data = await res.json();
    
    if (res.ok) {
      console.log('âœ… æ±ºæ¸ˆæ¤œè¨¼æˆåŠŸï¼');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      window.history.replaceState(null, '', window.location.pathname);
      
      // è³¼å…¥å±¥æ­´ã‚’å†å–å¾—
      const { data: bought } = await supabase
        .from('profile_purchases')
        .select('profile_id')
        .eq('user_id', user.id);
      
      setPurchases(bought?.map(p => p.profile_id) || []);
      
      alert('è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æ©Ÿèƒ½ãŒé–‹æ”¾ã•ã‚Œã¾ã—ãŸã€‚');
    } else {
      alert('æ±ºæ¸ˆã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
  }
};

// åˆæœŸåŒ–æ™‚ã®URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
useEffect(() => {
  const init = async () => {
    const params = new URLSearchParams(window.location.search);
    const paymentStatus = params.get('payment');
    const sessionId = params.get('session_id');
    const profileId = params.get('profile_id');
    
    if (paymentStatus === 'success' && sessionId) {
      await verifyPayment(sessionId, profileId);
    }
    
    // è³¼å…¥å±¥æ­´ã‚’å–å¾—
    const { data: bought } = await supabase
      .from('profile_purchases')
      .select('profile_id')
      .eq('user_id', user.id);
    
    setPurchases(bought?.map(p => p.profile_id) || []);
  };
  
  if (user) init();
}, [user]);
```

### 6.7 Proæ©Ÿèƒ½ã®é–‹æ”¾åˆ¤å®š

```javascript
// è³¼å…¥æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š
const isPurchased = (profileId) => purchases.includes(profileId);

// UIè¡¨ç¤º
{isPurchased(profile.id) ? (
  <>
    <button onClick={() => downloadHTML(profile)}>
      HTMLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
    <button onClick={() => showEmbedCode(profile)}>
      åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰
    </button>
  </>
) : (
  <button onClick={() => handlePurchase(profile)}>
    æ©Ÿèƒ½é–‹æ”¾ / å¯„ä»˜
  </button>
)}
```

---

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 7.1 ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” |
|-----------|------|
| `profiles` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«LPã®ãƒ‡ãƒ¼ã‚¿ |
| `analytics` | ã‚¢ã‚¯ã‚»ã‚¹è§£æãƒ‡ãƒ¼ã‚¿ |
| `leads` | ãƒªãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ |
| `profile_purchases` | è³¼å…¥å±¥æ­´ |
| `announcements` | ãŠçŸ¥ã‚‰ã›ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ |

### 7.2 profiles ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
CREATE TABLE IF NOT EXISTS profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  nickname TEXT,  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰
  content JSONB NOT NULL,  -- ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONé…åˆ—ï¼‰
  settings JSONB DEFAULT '{}',  -- è¨­å®šãƒ‡ãƒ¼ã‚¿ï¼ˆè¨ˆæ¸¬ã‚¿ã‚°ã€ãƒ†ãƒ¼ãƒãªã©ï¼‰
  user_id UUID REFERENCES auth.users(id),
  featured_on_top BOOLEAN DEFAULT true,  -- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸æ²è¼‰ãƒ•ãƒ©ã‚°
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLSãƒãƒªã‚·ãƒ¼
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- èª°ã§ã‚‚é–²è¦§å¯èƒ½
CREATE POLICY "Anyone can view profiles" ON profiles FOR SELECT USING (true);

-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½œæˆå¯èƒ½
CREATE POLICY "Authenticated users can create profiles" ON profiles 
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

-- ä½œæˆè€…ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "Users can update their own profiles" ON profiles 
  FOR UPDATE USING (auth.uid() = user_id);

-- ä½œæˆè€…ã®ã¿å‰Šé™¤å¯èƒ½
CREATE POLICY "Users can delete their own profiles" ON profiles 
  FOR DELETE USING (auth.uid() = user_id);
```

### 7.3 analytics ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- supabase_analytics_setup.sql

CREATE TABLE IF NOT EXISTS analytics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  profile_id UUID NOT NULL,
  event_type TEXT NOT NULL CHECK (event_type IN ('view', 'click', 'scroll', 'time', 'read')),
  event_data JSONB DEFAULT '{}'::JSONB,
  content_type TEXT DEFAULT 'profile',  -- 'profile' ã¾ãŸã¯ 'business'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_analytics_profile_id ON analytics(profile_id);
CREATE INDEX idx_analytics_event_type ON analytics(event_type);
CREATE INDEX idx_analytics_created_at ON analytics(created_at DESC);

-- RLSãƒãƒªã‚·ãƒ¼
ALTER TABLE analytics ENABLE ROW LEVEL SECURITY;

-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Šãƒ»æŒ¿å…¥å¯èƒ½ï¼ˆåŒ¿åãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®ãŸã‚ï¼‰
CREATE POLICY "Anyone can read analytics" ON analytics FOR SELECT USING (true);
CREATE POLICY "Anyone can insert analytics" ON analytics FOR INSERT WITH CHECK (true);
```

### 7.4 profile_purchases ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
-- supabase_profile_purchases_setup.sql

CREATE TABLE IF NOT EXISTS profile_purchases (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  profile_id UUID NOT NULL,
  stripe_session_id TEXT NOT NULL UNIQUE,  -- é‡è¤‡é˜²æ­¢
  amount INTEGER NOT NULL,  -- é‡‘é¡ï¼ˆå††ï¼‰
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_profile_purchases_user_id ON profile_purchases(user_id);
CREATE INDEX idx_profile_purchases_profile_id ON profile_purchases(profile_id);
CREATE INDEX idx_profile_purchases_stripe_session_id ON profile_purchases(stripe_session_id);

-- RLSãƒãƒªã‚·ãƒ¼
ALTER TABLE profile_purchases ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®è³¼å…¥å±¥æ­´ã®ã¿é–²è¦§å¯èƒ½
CREATE POLICY "Users can view their own purchases" ON profile_purchases 
  FOR SELECT USING (auth.uid() = user_id);

-- ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ï¼ˆAPIï¼‰ã®ã¿æŒ¿å…¥å¯èƒ½
CREATE POLICY "Service role can insert purchases" ON profile_purchases 
  FOR INSERT WITH CHECK (true);
```

---

## 8. è»¢ç”¨æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 8.1 å¿…é ˆç’°å¢ƒå¤‰æ•°

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key  # â† æ±ºæ¸ˆæ¤œè¨¼ã«å¿…é ˆ

# Stripeï¼ˆæ±ºæ¸ˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰
STRIPE_SECRET_KEY=sk_test_... ã¾ãŸã¯ sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_... ã¾ãŸã¯ pk_live_...

# ã‚µã‚¤ãƒˆURL
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# OpenAIï¼ˆAIç”Ÿæˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰
OPENAI_API_KEY=sk-...
```

### 8.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. `supabase_analytics_setup.sql` ã‚’å®Ÿè¡Œ
2. `supabase_profile_purchases_setup.sql` ã‚’å®Ÿè¡Œ
3. Supabase Storageã« `profile-uploads` ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ

### 8.3 ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã‚’è»¢ç”¨ã™ã‚‹å ´åˆ

- [ ] `components/ProfileEditor.tsx` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `lib/types.ts` ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ–ãƒ­ãƒƒã‚¯å‹å®šç¾©ï¼‰
- [ ] `constants/templates.ts` ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
- [ ] `components/BlockRenderer.tsx` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `app/actions/profiles.ts` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `app/api/upload-image/route.js` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] å¿…è¦ã«å¿œã˜ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### 8.4 ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã‚’è»¢ç”¨ã™ã‚‹å ´åˆ

- [ ] `components/ProfileViewTracker.tsx` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `components/LinkClickTracker.tsx` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `components/TrackingScripts.tsx` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `app/actions/analytics.ts` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `app/api/analytics/route.ts` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `supabase_analytics_setup.sql` ã‚’å®Ÿè¡Œ
- [ ] `content_type` ã‚’å¿…è¦ã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### 8.5 æ±ºæ¸ˆæ©Ÿèƒ½ã‚’è»¢ç”¨ã™ã‚‹å ´åˆ

- [ ] `app/api/checkout-profile/route.js` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `app/api/verify-profile/route.js` ã‚’ã‚³ãƒ”ãƒ¼
- [ ] `supabase_profile_purchases_setup.sql` ã‚’å®Ÿè¡Œ
- [ ] Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
- [ ] å•†å“åãƒ»èª¬æ˜æ–‡ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- [ ] success_urlãƒ»cancel_url ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- [ ] ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§æ±ºæ¸ˆãƒ†ã‚¹ãƒˆ

### 8.6 ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ

| é …ç›® | ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|------|---------|---------|
| ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—è¿½åŠ  | `lib/types.ts` | æ–°ã—ã„å‹å®šç¾©ã‚’è¿½åŠ  |
| ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ  | `constants/templates.ts` | æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ  |
| å•†å“åå¤‰æ›´ | `app/api/checkout-profile/route.js` | `product_data.name` ã‚’å¤‰æ›´ |
| ä¾¡æ ¼è¨­å®šå¤‰æ›´ | `app/api/checkout-profile/route.js` | æœ€ä½/æœ€é«˜é‡‘é¡ã‚’å¤‰æ›´ |
| è¨ˆæ¸¬ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ  | `app/actions/analytics.ts` | æ–°ã—ã„event_typeã‚’è¿½åŠ  |

---

## è£œè¶³è³‡æ–™

- `PAYMENT_SYSTEM_MIGRATION_GUIDE.md` - æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ãªç§»æ¤ã‚¬ã‚¤ãƒ‰
- `EDITOR_FILES_GUIDE.md` - ã‚¨ãƒ‡ã‚£ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°èª¬æ˜
- `ANALYTICS_SETUP.md` - ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
- `PROJECT_SPECIFICATION.md` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·åˆä»•æ§˜æ›¸

---

æœ€çµ‚æ›´æ–°æ—¥: 2024å¹´12æœˆ27æ—¥

